\section{Components and Capabilities of the LSST Alert Distribution System}\label{sec:components}

Description of the end-to-end system from data acquisition to scientific use of {\tt Alerts}.

\subsection{Overview of LSST Data Acquisition, Transfer, and Processing}

This section will discuss the relevant aspects of the fiber networks, NCSA, and Alert Generation pipelines.

\subsubsection{Fiber Networks}

\subsubsection{National Center for Supercomputing Applications (NCSA)}

\subsubsection{Alert Generation Pipeline}\label{sssec:AGP}

% MLG draft
The prompt pipeline that processes data during the night and generates {\tt Alerts} is described in \citeds{LSE-163}, with detailed descriptions of its algorithmic components provided in \citeds{LDM-151}. The basic modules include data reduction (e.g., instrument signature removal), difference imaging analysis (DIA; the subtraction of a template image), and source detection, association, and measurement \citedsp{LSE-163}. The LSST Data Management team anticipates that all standard and alternative standard visits ($2\times15$ or $1\times30$ exposures, respectively), whether obtained as part of the main wide-fast-deep (WFD) survey or a Special Program, can and will be processed by the Prompt Pipeline and used to generate {\tt Alerts}. The caveat might be images of fields too crowded for the prompt pipeline to successfully produce alerts within {\tt OTT1 = 1} minute (DMS-REQ-0004, \citeds{LSE-61}; however, elastically allocated computational resource might be applied to handle DIA in crowded fields). In addition, the prompt pipeline might also be able to process non-standard visits with longer or shorter exposure times provided that, e.g., the visit image can be successfully PDF-matched and differenced with a template image. The prompt pipeline's capabilities in this respect are to be determined; see \citeds{DMTN-065} for a summary of the diversity of data from Special Programs.

% MLG draft
All sources in a difference image that have a signal-to-noise ratio ${\rm SNR}>5$ in positive or negative flux are considered ``detected" and incorporated into the {\tt DIASource} catalog, and will cause an {\tt Alert} to be issued. Exceptions to this rule may include: (1) sources with ${\rm SNR} > 5$ that have a {\it ``high probability of being instrumental non-astrophysical artifacts"} \citedsp{LSE-163} from e.g., a to-be-determined spuriousness or real/bogus classifier \citedsp{LDM-151}; (2) sources with ${\rm SNR} < 5$ that meet other criteria, such as being near one of Earth's gravitational keyholes (i.e., a potentially hazardous asteroid). Additionally some ${\rm SNR} < 5$ sources will be kept for diagnostic purposes, but will not lead to {\tt Alerts}. Source association and measurement occurs prior to {\tt Alert} generation: every {\tt DIASource} will have one unique match to a {\tt DIAOjbect} (stationary object) or Solar System Object {\tt SSObject} (moving object; see Section \ref{sssec:AGP_MOPS}). The stationary source association algorithms will be probabilistic and incorporate motion models for parallax and proper motion \citedsp{LDM-151}. If no association is possible a new {\tt DIAObject} is created. Source measurements including centroid, fluxes, shapes, and other characterization parameters (see e.g., Table 1 of \citeds{LSE-163}) are made, and the time-evolving parameters of {\tt DIAObject} such as the parallax, mean flux, and periodic/non-periodic light curve features, are updated to include the new associated {\tt DIASource}. At this point, the {\tt DIASource} is used to create an {\tt Alert} packet, which is described in Section \ref{ssec:packets}.

%%%MLG commented out the following statements on Tue Apr 3.
% Deblending for difference image sources will only be run if necessary (\citeds{LSE-163}, page 11). 
%One exception is sources with $SNR>5$ but also a {\it ``high probability of being instrumental non-astrophysical artifacts"} \cite{LSE-163}. The application of real/bogus (spuriousness) algorithms might only be done if the fraction of false positives is greater than 50\% (\citeds{LDM-151}; OSS-REQ-0354) {\bf (but how would that be known without first applying real-bogus?)}. Rejected sources might not be persisted (i.e., not included in the {\tt DIASource} catalog and no {\tt Alert} is triggered). \citeds{LDM-151} states that the default technique will be {\it ``based on a trained random forest classifier ... conditioned on the image quality and airmass of the observation''}, but otherwise the spuriousness algorithm is very sparsely defined in \citeds{LDM-151}: {\it ``Some per-source measure of likelihood the detection is junk. May use machine learning on other measurements or pixels. May be augmented by spuriousness measures that aren't purely per-source"} (page 118-11). Another exception is a small fraction of high-priority sources with $SNR<5$ that meet some set of criteria, such as $SNR>3$ and near one of Earth's gravitational keyholes (i.e., a potentially hazardous asteroid), would be persisted and lead to {\tt Alerts} (Section 3.2.1, \citeds{LSE-163}). Additionally, some $SNR<5$ {\tt DIASources} will be kept for diagnostic purposes but not lead to {\tt Alerts}.
% It is important to note that, especially in crowded fields, there might be instances of {\tt DIASource} association reassignment as, e.g., motion models improve over time. {\tt DIASources} will also be matched by location to the 3 nearest stars and 3 nearest galaxies in the {\tt Objects} catalog from the last data release with a probability of association provided for each (\citeds{LDM-151}).
%{\it Common Question: Will Alerts be released after 60 or 120 seconds?} The requirement governing the latency of reporting on optical transients -- the time between shutter close and {\tt Alert} distribution -- is {\tt OTT1 = 1} minute (DMS-REQ-0004, \citeds{LSE-61}). {\bf Other relevant quantities such as GB processed per minute, number of {\tt DIASources} per visit, number of {\tt DIAObjects} survey-total, etc.?}

\subsubsection{Moving Objects Processing System}\label{sssec:AGP_MOPS}

% MLG draft
The bulk of the Moving Objects Processing System (MOPS; \citeds{LDM-156}) runs in the day using algorithms that generate tracklets and fit orbits to identify and characterize moving objects. All identified moving objects are stored in the {\tt SSObject} catalog. MOPS will interface with the Minor Planets Center (MPC) and will ingest all previously known or externally identified moving objects into the {\tt SSObjects} catalog, and use MPC astrometry in the orbital parameter fits. As part of Alert Generation, the night-MOPS pipeline will calculate the predicted locations of {\tt SSObjects} in each newly acquired visit image for fast and accurate source association. {\tt Alerts} will be issued on ${\rm SNR} > 5$ detections of all moving sources.

\subsubsection{Forced Photometry}

Forced photometry is performed on difference images in two ways; neither are in the direct path to Alert Generation and do not contribute to the {\tt Alert} packet contents, but both are a part of prompt processing. First, forced photometry is done on every difference image at the locations of all {\tt DIAObjects} detected in the past 12 months, and the results are stored as flagged {\tt DIASources} (or in an equivalent but separate table). This happens in real time as a part of DIA, and the {\tt DIASource} and {\tt DIAObject} catalogs are updated during the night. Second, forced photometry is done at the locations of all {\em new} sources (i.e., unassociated) on every difference image from the past 30 days. This is commonly referred to as ``precovery" photometry, and the results will be stored as flagged {\tt DIASources} (or in an equivalent but separate table). Precovery photometry will be completed and made available no later than the sunset of the following night.
%So long as it does not interfere with the processing for {\tt Alert} distribution, the forced photometry may be run at night.  
Additionally, a service shall be provided to users to obtain full-survey precovery for a limited number of {\tt DIAObjects}, also within 24 hours (DMS-REQ-0341, \citeds{LSE-61}). This service will be made available through the Science Platform.
% {\bf It seems that MOPS also does some precovery photometry in order to use predictions of tracklets and orbits as further constraints? E.g., Section 3.5.6 in LDM-151. Probably not necessary to include since it wound't contribute to Alerts.}


\subsection{Alert Packets}\label{ssec:packets}

% MLG draft
% {\it Common Question: What do Alerts contain? The full past light curve, non-detections, the host photo-z, etc. What will be the format of source association to e.g., DRP Objects: just ID numbers or the full record?}
The contents of an {\tt Alert} packet are fully described in Section 3.5.1 of \citeds{LSE-163}. We reproduce the list of included data here:
\renewcommand{\labelenumi}{\Roman{enumi}.}
\begin{enumerate}
\item an ID uniquely identifying the {\tt Alert}
\item the prompt products database ID
\item the {\tt DIASource} record that triggered the {\tt Alert}
\item the entire associated {\tt DIAObject} or {\it SSObject} record from the prompt products database
\item the previous 12 months of associated {\tt DIASource} records from the prompt products database
\item matching {\tt Object} IDs from the latest Data Release, if they exist, and 12 months of their {\tt DIASource} records
\item postage stamps of the difference image and template at the {\tt DIASource} location
\end{enumerate}

It is important to note that records from the prompt products database will never have a history of much more than the past 12 months; full-survey histories are only available in the data release pipeline products. Postage stamps are images that contain the entire footprint of the {\tt DIAObject} and will be no smaller than $6\arcsec \times 6\arcsec$. The image cut-outs will contain the data, variance, and mask frames for the difference and template images only. The full list of parameters that are measured and included in the {\tt DIASource} and {\tt DIAObject} records are provided in Tables 1 and 2 of \citeds{LSE-163}, respectively. The average size of an {\tt Alert} packet will be {\bf XXX?} kilobytes and {\bf XXX?} \% of this is the postage stamp. The {\em only} trigger for an {\tt Alert} is the detection of a source in a difference image with ${\rm SNR} > 5$: for example, objects that become saturated or return to the same brightness as in the template image will not generate an {\tt Alert}. Other observatory information such as telescope slews, dome closures, or changes to the weather conditions will not be issued as {\tt Alerts}. Samples of {\tt Alert} packets in the {\tt VOEvent} format can be found at {\bf [website X?]}.

{\bf MLG Questions:} \\
Item VI -- The wording has plural IDs, and refers first to {\tt Object} and then to {\tt DIASource}. It is unclear how many matches are being returned, and whether the matches are to {\tt Objects/Sources} or {\tt DIAObjects/DIASources}. \\
Item VI -- Why are 12 months of {\tt DIASources} from the data release pipeline being included in the {\tt Alert}, when (a) this might be mostly redundant with the past 12 months of prompt pipeline {\tt DIASources} and (b) the fully survey of {\tt DIASources} could be included instead. \\
Item VII -- A cutout of the new image is no longer being included? Or is this a DPDD oversight?

%%% MLG: these have been answered, above.
% Common Question: What is the size of the Alert packet and what fraction of that is image stamp?
% Common Question: Requests for descriptions of all cases that trigger Alerts in addition to a SNR>5 DIASource. For example: telescope slews, a source reaching saturation, the forced photometry done for all DIAObjects with detections in past 12 months.

\subsection{Alert Transport}

{\it Common Question: How will an interrupted stream recuperate from a slow-down? Will there be, for example, no alerts issued once they're older than 300s? (Probably the public will want all of the Alerts, even with comprised latency).}

{\it Common Question: How behind will the Alert Stream get during visits to crowded fields?} MLG notes that the answer might be ``not at all" if elastic computational resources are deployed at NCSA (convos with K.T.).


\subsection{Alert Stream Diagnostics?}

%MLG proposing this subsection
Perhaps here we could talk about some alert stream diagnostics to build. E.g., a "Alert Stream" homepage tracking alerts/s in the past 30, 300, and 3000 seconds; all-sky map of alert locations; "last image" with alert locations drawn on; real/bogus fraction; artifact pie-chart; apparent magnitude distributions; "hot oddities" ML-flagged outliers in shape or brightness; I don't know what all. Perhaps DM-Square team is already doing this?


\subsection{Community Brokers}

{\it Common Question: Do all brokers need to forward the raw alert stream publicly? This is also asked in Section \ref{sec:community_brokers}.}


\subsection{The LSST Data Access Center}

\subsubsection{Processed Images and Catalogs}

\subsubsection{L1 Database}

\subsubsection{Alert Database}

\subsubsection{The LSST mini-broker}

\subsubsection{The LSST Science Platform}

\subsection{Target Observation Managers?}

% MLG proposing this subsection
The final end use of alerts is not just brokers, but TOMs. Might LSST provide or support development for a Science Platform TOM that integrates with the LSST mini-broker? Some community brokers such as the future LASAIR (UK) have TOM functionality built in. 
